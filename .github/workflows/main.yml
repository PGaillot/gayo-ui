name: Deploy
run-name: ${{ github.actor }} deploy ${{ github.repository }} process 🚀

on:
    push:
        branches:
            - master

jobs: 
    build:
        runs-on: ubuntu-latest
        steps:
          - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
          - uses: actions/checkout@v3

          - name: 🪢 Use Node.js 18
            uses: actions/setup-node@v3
            with:
              node-version: 18.x

          - name: 🚀 Update version
            run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
            env:
             NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

          - run: 'cd projects/gayo-lib'
        
          - name: 🛠️ Install lib dependencies
            run: |
               npm ci
               npm install @octokit/rest
            
          - name: 📦 Publish lib
            run: node scripts/publish-package.cjs
            env:
              GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              OWNER: ${{ github.repository_owner }}
              REPO: ${{ github.repository }}

          - run: 'cd ../../'

          - name: 🏗️ Build Website
            run: npm run build-storybook

          - name: 🛠️ Install dependencies
            run: npm ci


          - name: 🤝 Deploy on Server 
          
            uses: appleboy/scp-action@v0.1.7
            with:
              host: ${{ secrets.SSH_HOST }} 
              username: ${{ secrets.SSH_USERNAME }}
              password: ${{ secrets.SSH_PASS }}
              port: ${{ secrets.SSH_PORT }}
              source: './storybook-static/*'
              target: '/var/www/html/${{ github.repository }}'
